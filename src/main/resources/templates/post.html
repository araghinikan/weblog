<!DOCTYPE html>
<html lang="fa" dir="rtl" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title}">Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø³Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
<header class="bg-blue-600 text-white shadow sticky top-0 z-50">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold">ÙˆØ¨Ù„Ø§Ú¯</h1>
        <nav class="space-x-4">
            <a href="/" class="hover:underline">Ø®Ø§Ù†Ù‡</a>
            <a href="/auth/login" class="hover:underline">ÙˆØ±ÙˆØ¯</a>
            <a href="/auth/register" class="hover:underline">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</a>
        </nav>
    </div>
</header>
<main class="container mx-auto px-6 py-10 flex-grow">
    <article class="bg-white rounded-xl shadow-lg p-8 mb-12">
        <h2 class="text-4xl font-bold mb-6 text-gray-900" th:text="${post.title}">Ø¹Ù†ÙˆØ§Ù† Ù¾Ø³Øª</h2>
        <div class="flex flex-wrap items-center gap-4 mb-8 text-sm text-gray-500">
            <span th:text="${post.category != null ? post.category.name : 'Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡'}">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</span>
            <span th:text="${#temporals.format(post.publishedAt,'yyyy-MM-dd HH:mm')}">ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ´Ø§Ø±</span>
            <span th:text="${post.author != null ? post.author.username : 'Ù†Ø§Ø´Ù†Ø§Ø³'}">Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</span>
        </div>
        <p class="text-xl text-gray-700 mb-8 leading-relaxed" th:text="${post.excerpt}">Ø®Ù„Ø§ØµÙ‡ Ù¾Ø³Øª</p>
        <div class="prose prose-lg max-w-none text-gray-800 leading-relaxed" th:utext="${post.content}">Ù…Ø­ØªÙˆØ§ÛŒ Ù¾Ø³Øª</div>
    </article>

    <!-- Comments Section -->
    <section id="comments-section" class="bg-white rounded-xl shadow-lg p-8 mb-12">
        <h3 class="text-2xl font-bold mb-8 text-gray-900 border-b pb-4">
            Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ <span id="comments-count">0</span>
        </h3>
        <div id="no-comments" class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">ğŸ’¬</div>
            <p class="text-xl">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§...</p>
        </div>
        <div id="approved-comments" class="mb-6"></div>
        <div id="pending-comments"></div>
    </section>

    <section class="bg-white rounded-xl shadow-lg p-8" sec:authorize="isAuthenticated()">
        <h3 class="text-2xl font-bold mb-8 text-gray-900 border-b pb-4">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù…Ù†Øª Ø¬Ø¯ÛŒØ¯</h3>
        <form id="commentForm" class="space-y-6">
            <input type="hidden" name="postId" th:value="${post.id}" id="postId"/>
            <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ù†Ø§Ù… Ø´Ù…Ø§:</label>
                <input type="text" name="authorName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§ÛŒÙ…ÛŒÙ„:</label>
                <input type="email" name="authorEmail" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required placeholder="example@email.com"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ù…ØªÙ† Ú©Ø§Ù…Ù†Øª:</label>
                <textarea name="content" rows="5" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-vertical" required placeholder="Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg">Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ù…Ù†Øª</button>
        </form>
    </section>
    <section class="bg-white rounded-xl shadow-lg p-12 text-center" sec:authorize="isAnonymous()">
        <div class="text-6xl mb-6">ğŸ”’</div>
        <h3 class="text-2xl font-bold text-gray-900 mb-4">Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù…Ù†Øª Ú¯Ø°Ø§Ø´ØªÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</h3>
        <a href="/auth/login" class="bg-blue-600 text-white px-8 py-4 rounded-xl font-semibold hover:bg-blue-700 transition">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</a>
    </section>
</main>
<footer class="bg-gray-900 text-gray-300 py-8 mt-auto">
    <div class="container mx-auto px-6 text-center">
        <p>Â© 2025 ÙˆØ¨Ù„Ø§Ú¯. Ù‡Ù…Ù‡ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.</p>
    </div>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded');
        const postId = document.getElementById('postId')?.value;
        if (postId) {
            loadComments(postId);
        }

        const form = document.getElementById('commentForm');
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await submitComment();
            });
        }
    });

    async function loadComments(postId) {
        try {
            console.log('Loading comments for post:', postId);
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² CommentController endpoint âœ…
            const response = await fetch(`/comments/post/${postId}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const comments = await response.json();
            console.log('Comments loaded:', comments);

            renderComments(comments);
        } catch (error) {
            console.error('Load comments error:', error);
            showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§', 'error');
        }
    }

    async function submitComment() {
        const form = document.getElementById('commentForm');
        const postId = document.getElementById('postId').value;
        const formData = new FormData(form);
        const csrfToken = formData.get('_csrf');

        const data = {
            postId: parseInt(postId),
            authorName: formData.get('authorName').trim(),
            authorEmail: formData.get('authorEmail').trim(),
            content: formData.get('content').trim()
        };

        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = 'â³ Ø§Ø±Ø³Ø§Ù„...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });

            const result = await response.json().catch(() => response.text());

            if (response.ok) {
                showMessage('âœ… Ú©Ø§Ù…Ù†Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ùˆ Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ø§Ø³Øª!', 'success');
                form.reset();
                // Reload comments.html ÙÙˆØ±Ø§Ù‹ (pending comment Ù‚Ø±Ù…Ø² Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´Ù‡)
                await loadComments(postId);
            } else {
                showMessage('âŒ ' + (result || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'), 'error');
            }
        } catch (error) {
            console.error('Submit error:', error);
            showMessage('âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡', 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    function renderComments(comments) {
        const approvedSection = document.getElementById('approved-comments');
        const pendingSection = document.getElementById('pending-comments');
        const noComments = document.getElementById('no-comments');
        const countSpan = document.getElementById('comments-count');

        // Clear sections
        approvedSection.innerHTML = '';
        pendingSection.innerHTML = '';

        const approvedCount = comments.filter(c => c.approved === 1).length;
        const pendingCount = comments.filter(c => c.approved === 0).length;
        countSpan.textContent = approvedCount + pendingCount;

        if (approvedCount + pendingCount === 0) {
            noComments.innerHTML = `
            <div class="text-6xl mb-4">ğŸ’¬</div>
            <p class="text-xl">Ù‡Ù†ÙˆØ² Ú©Ø§Ù…Ù†ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
        `;
            return;
        }

        noComments.style.display = 'none';

        // Sort: approved first, then pending (newest first)
        const sortedComments = comments.sort((a, b) => {
            if (a.approved !== b.approved) return b.approved - a.approved;
            return new Date(b.createdAt) - new Date(a.createdAt);
        });

        sortedComments.forEach(comment => {
            const div = document.createElement('div');
            div.className = comment.approved === 0
                ? 'border py-6 rounded-xl mb-4 transition-all duration-200 hover:bg-gray-50 border-red-300 bg-red-50 shadow-md ring-2 ring-red-200/50'
                : 'border py-6 rounded-xl mb-4 transition-all duration-200 hover:bg-gray-50 border-gray-200';

            if (comment.approved === 0) {
                div.innerHTML = `
                <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 mb-3">
                    â³ Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ±
                </div>
                <div class="text-lg mb-3 leading-relaxed text-red-800">${escapeHtml(comment.content)}</div>
                <div class="flex flex-wrap items-center justify-between text-sm text-gray-500 gap-2">
                    <span>${escapeHtml(comment.authorName)}</span>
                    ${comment.authorEmail ? `<span>âœ‰ï¸ ${escapeHtml(comment.authorEmail)}</span>` : ''}
                    <span>${comment.createdAt}</span>
                </div>
            `;
                pendingSection.appendChild(div);
            } else {
                div.innerHTML = `
                <div class="text-lg mb-3 leading-relaxed text-gray-900">${escapeHtml(comment.content)}</div>
                <div class="flex flex-wrap items-center justify-between text-sm text-gray-500 gap-2">
                    <span>${escapeHtml(comment.authorName)}</span>
                    ${comment.authorEmail ? `<span>âœ‰ï¸ ${escapeHtml(comment.authorEmail)}</span>` : ''}
                    <span>${comment.createdAt}</span>
                </div>
            `;
                approvedSection.appendChild(div);
            }
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showMessage(text, type) {
        const div = document.createElement('div');
        div.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl text-white text-lg font-medium transform translate-x-full transition-all duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        div.innerHTML = `<strong>${text}</strong>`;
        document.body.appendChild(div);
        setTimeout(() => div.classList.remove('translate-x-full'), 100);
        setTimeout(() => {
            div.classList.add('translate-x-full');
            setTimeout(() => document.body.removeChild(div), 300);
        }, 4000);
    }
</script>
</body>
</html>
